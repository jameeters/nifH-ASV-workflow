##
## Create the nifH ASV database which has:
##  * filtered AUID sequences, abundances, and annotations
##  * sample metadata
##  * CMAP envrionmental data
##
## The nifH ASV database is provided in two ways:
##  - nifH_ASV_database.tgz:  Separate files for each component of the DB
##  - workspace.RData:        Data frames for DB components and a few helper functions.
##
## Useful targets:
##   make status	- Print timestamps for files used by this Makefile
##   make               - Makes the nifH_ASV_database.tgz and workspace.RData
##   make all           - Same as previous
##   make clean         - Delete nifH_ASV_database.tgz and workspace.RData
##

SHELL=/usr/bin/bash

##
## Inputs generated by Makefiles from previously executed workflow stages.
##

## From FilterAuids stage
FILTDIR      := $(abspath ../FilterAuids)
FILTABUNDTAB := $(addprefix $(FILTDIR)/,auid.abundances.filtered.tsv.gz)
FILTFASTA    := $(addprefix $(FILTDIR)/,auid.filtered.fasta)

## From GatherMetadata stage
METADIR      := $(abspath ../GatherMetadata)
#CMAPMETA     := $(addprefix $(METADIR)/,metadata.cmap.tsv)
SAMPMETA     := $(addprefix $(METADIR)/,metadata.tsv)

## From AnnotateAuids stage
ANNOTDIR     := $(abspath ../AnnotateAuids)
ANNOTATION   := $(addprefix $(ANNOTDIR)/,auids.annot.tsv)

## From CMAP stage
## FIXME: Currently there is old CMAP environmental data obtained manually by Mo (on 20220831) for
## some earlier version of metadata.cmap.tsv.
CMAPDIR  := $(abspath ../CMAP)
CMAPDATA := $(addprefix $(CMAPDIR)/,CMAP_data.csv.gz)

##
## The one script for this stage, and its outputs.  The "sampsWithout" files are diagnostic and not
## part of the nifH ASV database.
##
MAKENIFHASVDB := $(abspath scripts/make_nifH_ASV_database.R)
INPUTS        := $(FILTABUNDTAB) $(FILTFASTA) $(ANNOTATION) $(SAMPMETA) $(CMAPDATA)
OUTPUTS       := nifH_ASV_database.tgz workspace.RData \
	         $(addprefix sampsWithout,Metadata.txt Envdata.txt)

all: $(OUTPUTS)

.PHONY: clean
clean:
	rm -f $(OUTPUTS)


## fixme: Simplify file path ideally to just the stage dir and file name. (Sed to drop `pwd`)
.PHONY: status
status:
	@echo "Here are the main input files sorted by oldest to newest modification time:"
	@stat --printf='%y\t%-16n\n' `ls -rt $(INPUTS)` | sed -e 's/\.[0-9][0-9]*.*\t/\t/'
	@echo

## Make the nifH ASV database and the workspace
$(OUTPUTS) &: $(INPUTS)
	@echo ">>>>> Making the nifH ASV database <<<<<"
	@$(MAKENIFHASVDB) $^
	@echo ">>>>> Finished making the nifH ASV database <<<<<"
	@echo
